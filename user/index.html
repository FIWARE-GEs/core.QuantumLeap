<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Introduction - QuantumLeap</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  <link href="https://fiware.org/style/fiware_readthedocs.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Introduction";
    var mkdocs_page_input_path = "user/index.md";
    var mkdocs_page_url = "/user/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> QuantumLeap</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">User & Programmers Manual</span>
    <ul class="subnav">
                <li class=" current">
                    
    <a class="current" href="./">Introduction</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#using-quantumleap">Using QuantumLeap</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#orion-subscription">Orion Subscription</a></li>
        
            <li><a class="toctree-l4" href="#data-insertion">Data Insertion</a></li>
        
            <li><a class="toctree-l4" href="#data-retrieval">Data Retrieval</a></li>
        
            <li><a class="toctree-l4" href="#data-removal">Data Removal</a></li>
        
            <li><a class="toctree-l4" href="#multi-tenancy">Multi-tenancy</a></li>
        
            <li><a class="toctree-l4" href="#geocoding">GeoCoding</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="troubleshooting/">Troubleshooting</a>
                </li>
                <li class="">
                    
    <a class="" href="contributing/">Contributing</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Installation & Administration Manual</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../admin/">Introduction</a>
                </li>
                <li class="">
                    
    <a class="" href="../admin/ports/">Ports</a>
                </li>
                <li class="">
                    
    <a class="" href="../admin/crate/">Crate</a>
                </li>
                <li class="">
                    
    <a class="" href="../admin/grafana/">Grafana</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">QuantumLeap</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>User & Programmers Manual &raquo;</li>
        
      
    
    <li>Introduction</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/smartsdk/ngsi-timeseries-api.git/edit/master/docs/user/index.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="using-quantumleap">Using QuantumLeap</h1>
<p>First you need to have QuantumLeap and its complementary services running (of
course). Refer to the <a href="../admin/">Installation Manual</a> for instructions.</p>
<p>Then, you need to connect <em>Orion Context Broker</em> to QuantumLeap through an <a href="https://fiware-orion.readthedocs.io/en/master/user/walkthrough_apiv2/index.html#subscriptions">NGSIv2
subscription</a>
for each <a href="https://orioncontextbroker.docs.apiary.io/#introduction/specification/terminology">Entity Type</a>
whose historical data you are interested in.</p>
<p>Not an Orion expert yet? No problem, you can create the subscription through
QuantumLeap's API. However, you will still need to understand the basics of
how subscriptions and notifications work, so take a time to read
<a href="https://fiware-orion.readthedocs.io/en/master/user/walkthrough_apiv2/index.html#ubscriptions">the docs</a>.</p>
<p>Historical data for each entity type will be persisted as long as the
subscription is active, correctly configured and the entity in the notification
is NGSI compliant.</p>
<p>So, summing up, the usage flow is therefore the following...</p>
<ul>
<li>Create an Orion subscription for each entity type of your interest</li>
<li>Insert/Update your data in Orion as usual</li>
<li>Your historical data will be persisted in QuantumLeap's database</li>
</ul>
<p>Let's take a closer look at each step.</p>
<h2 id="orion-subscription">Orion Subscription</h2>
<p>As stated before, the link between Orion and QuantumLeap is established
through a subscription you need to create. It is therefore important that you
understand well how the NGSIv2 Subscription mechanism works. This is carefully
explained in the corresponding section of <a href="https://fiware-orion.readthedocs.io/en/master/user/walkthrough_apiv2/index.html#subscriptions">Orion docs</a>.</p>
<p>To create the subscription, QuantumLeap offers an API endpoint documented
<a href="https://app.swaggerhub.com/apis/smartsdk/ngsi-tsdb/0.1#/input/reporter.reporter.subscribe">here</a>.</p>
<p>Alternatively, you can directly talk to Orion and create the subscription as you
prefer. Here's an example of the payload of the subscription you need to create
in Orion to establish the link Orion-QuantumLeap.</p>
<pre><code>    {
        &quot;description&quot;: &quot;Test subscription&quot;,
        &quot;subject&quot;: {
            &quot;entities&quot;: [
            {
                &quot;idPattern&quot;: &quot;.*&quot;,
                &quot;type&quot;: &quot;Room&quot;
            }
            ],
            &quot;condition&quot;: {
                &quot;attrs&quot;: [
                &quot;temperature&quot;
                ]
            }
        },
        &quot;notification&quot;: {
            &quot;http&quot;: {
                &quot;url&quot;: &quot;http://quantumleap:8668/v2/notify&quot;
            },
            &quot;attrs&quot;: [
            &quot;temperature&quot;
            ],
            &quot;metadata&quot;: [&quot;dateCreated&quot;, &quot;dateModified&quot;]
        },
        &quot;throttling&quot;: 5
    }
</code></pre>

<p>Important things to notice from the subscription.</p>
<ul>
<li>
<p>Notifications must come in complete <a href="http://docs.orioncontextbroker.apiary.io/#introduction/specification/json-attribute-representation">NGSI JSON Entity Representation</a>
 form. Other forms, such as the <a href="http://docs.orioncontextbroker.apiary.io/#introduction/specification/simplified-entity-representation">simplified entity representation</a>
 are <strong>NOT</strong> supported by QL because they lack information on attribute types,
 required by QL to make proper translations. This means, <em>DO NOT</em> use options
 like <code>"attrsFormat": "keyValues"</code></p>
</li>
<li>
<p>The <code>"url"</code> field of the subscription specifies where Orion will send the
notifications. I.e, this must be QuantumLeap's <code>/v2/notify</code> endpoint.
By default, QuantumLeap listens at port <code>8668</code>. This url must be resolvable
from Orion's container, so avoid using <em>localhost</em> or something that will not
translate either by Docker, your <code>/etc/hosts</code> or DNS to the endpoint where
QuantumLeap is running.</p>
</li>
<li>
<p>Though not compulsory, it is highly recommended to include the
<code>"metadata": ["dateCreated", "dateModified"]</code> part in the <code>notification</code>
part of the subscription. This instructs Orion to include the modification time
of the attributes in the notification. This timestamp will be used as the time
index in the database. If this is somehow missing, QuantumLeap will use its
current system time at which the notification arrived, which might not be
exactly what you want.</p>
</li>
<li>
<p>You can create any valid NGSI subscription for your entities respecting the
previous rules.</p>
</li>
</ul>
<h2 id="data-insertion">Data Insertion</h2>
<p>By now, it should be clear you don't typically insert data directly into
QuantumLeap. You insert into Orion and Orion notifies QuantumLeap.
For inserts and updates in Orion, refer to the <a href="http://fiware-orion.readthedocs.io/en/latest/user/walkthrough_apiv2/index.html#issuing-commands-to-the-broker">docs</a>.</p>
<p>It's not a problem if inserts were done before you created the
subscription. Of course, you will only get historical records of the updates
happening after the subscription was created.</p>
<p>Here's an example of an insert payload to Orion that will generate a
notification to QuantumLeap based on the "Test subscription" example shown
before.</p>
<pre><code>{
    &quot;id&quot;: &quot;Room1&quot;,
    &quot;type&quot;: &quot;Room&quot;,
    &quot;temperature&quot;: {
        &quot;value&quot;: 24.2,
        &quot;type&quot;: &quot;Number&quot;,
        &quot;metadata&quot;: {}
    },
    &quot;pressure&quot;: {
        &quot;value&quot;: 720,
        &quot;type&quot;: &quot;Number&quot;,
        &quot;metadata&quot;: {}
    }
    &quot;colour&quot;: {
        &quot;value&quot;: &quot;white&quot;,
        &quot;type&quot;: &quot;Text&quot;,
        &quot;metadata&quot;: {}
    }
}
</code></pre>

<p>If you have a custom scenario and still want to directly insert to QuantumLeap,
it is not impossible. However, you will have to use the same payload Orion uses
in the Notification. Also, you will need attention to some other details you
will have to discover on your own. This is not fully documented because it's not
considered a common workflow.</p>
<h3 id="attributes-datatype-translation">Attributes DataType Translation</h3>
<p>You need to make sure your NGSI entities are using the valid NGSI types for the
attributes, which are documented in the <em>Specification</em> section of the <a href="http://telefonicaid.github.io/fiware-orion/api/v2/latest/">NGSI API</a>. See the first
column of the translation table below, and mind its capitalisation.</p>
<p>The table below shows which attribute types will be translated to which
<a href="https://crate.io/docs/crate/reference/sql/data_types.html">Crate Data Types</a>.</p>
<p><strong>Crate Translation Table</strong></p>
<table>
<thead>
<tr>
<th>NGSI Type</th>
<th align="center">Crate Type</th>
<th align="left">Observation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Array</td>
<td align="center"><a href="https://crate.io/docs/crate/reference/sql/data_types.html#array">array(string)</a></td>
<td align="left"><a href="https://github.com/smartsdk/ngsi-timeseries-api/issues/36">Issue 36: Support arrays of other types</a></td>
</tr>
<tr>
<td>Boolean</td>
<td align="center"><a href="https://crate.io/docs/crate/reference/sql/data_types.html#boolean">boolean</a></td>
<td align="left">-</td>
</tr>
<tr>
<td>DateTime</td>
<td align="center"><a href="https://crate.io/docs/crate/reference/sql/data_types.html#timestamp">timestamp</a></td>
<td align="left">'ISO8601' can be used as equivalent of 'DateTime'.</td>
</tr>
<tr>
<td>Integer</td>
<td align="center"><a href="https://crate.io/docs/crate/reference/sql/data_types.html#numeric-types">long</a></td>
<td align="left">-</td>
</tr>
<tr>
<td><a href="http://docs.orioncontextbroker.apiary.io/#introduction/specification/geospatial-properties-of-entities">geo:point</a></td>
<td align="center"><a href="https://crate.io/docs/crate/reference/sql/data_types.html#geo-point">geo_point</a></td>
<td align="left"><strong>Attention!</strong> NGSI uses "lat, long" order whereas Crate stores points in [long, lat] order.</td>
</tr>
<tr>
<td><a href="http://docs.orioncontextbroker.apiary.io/#introduction/specification/geospatial-properties-of-entities">geo:json</a></td>
<td align="center"><a href="https://crate.io/docs/crate/reference/sql/data_types.html#geo-shape">geo_shape</a></td>
<td align="left">-</td>
</tr>
<tr>
<td>Number</td>
<td align="center"><a href="https://crate.io/docs/crate/reference/sql/data_types.html#numeric-types">float</a></td>
<td align="left">-</td>
</tr>
<tr>
<td>Text</td>
<td align="center"><a href="https://crate.io/docs/crate/reference/sql/data_types.html#string">string</a></td>
<td align="left">This is the default type if the provided NGSI Type is unsupported or wrong.</td>
</tr>
<tr>
<td>StructuredValue</td>
<td align="center"><a href="https://crate.io/docs/crate/reference/sql/data_types.html#object">object</a></td>
<td align="left">-</td>
</tr>
</tbody>
</table>
<p>If the type of any of the received attributes is not present in the column
<em>NGSI Type</em> of the previous table, the value of such attribute will be treated
internally as a string. So, if you use <code>Float</code> for your attribute type (not
valid), your attribute will be stored as a <code>string</code>.</p>
<h3 id="restrictions-and-limitations">Restrictions and Limitations</h3>
<ul>
<li>
<p>You cannot have two entity types with the same name but different
capitalisation. E.g: <code>Preprocessor</code> and <code>preProcessor</code>. The same applies for
attribute names of a given entity. I.e, attributes <code>hotSpot</code> and <code>hotspot</code>
will be treated as the same. These are rare corner-cases, but it is worth
keeping in mind this. Ultimately, the correct naming of types and attributes
should respect the naming guidelines explained
<a href="http://fiware-datamodels.readthedocs.io/en/latest/guidelines/index.html">here</a>.</p>
</li>
<li>
<p>Attributes metadata are still not being persisted. See <a href="https://github.com/smartsdk/ngsi-timeseries-api/issues/12">Issue 12</a></p>
</li>
</ul>
<h2 id="data-retrieval">Data Retrieval</h2>
<p>To retrieve historical data from QuantumLeap, you can use the API endpoints
documented <a href="https://app.swaggerhub.com/apis/smartsdk/ngsi-tsdb/0.1#/queries">here</a>.
Note there are a lot of possibilities, but not all of them are fully
implemented yet.</p>
<p>If you want to, you can interact directly with the database. For more details
refer to the <a href="../admin/crate/">Crate</a> section of the docs. What you need to
know in this case is that QuantumLeap will create one table per each entity
type. Table names are formed with a prefix (et) plus the lowercase version of
the entity type. I.e, if your entity type is <em>AirQualityObserved</em>, the
corresponding table name will be <em>etairqualityobserved</em>. Table names should be
prefixed also with the schema where they are defined. See the
<a href="#multi-tenancy">Multi-tenancy</a> section below.</p>
<p>Finally, you can interact with your data visually using <a href="https://grafana.com/">Grafana</a>.
See the <a href="../admin/grafana/">Grafana</a> section of the docs to see how.</p>
<h3 id="time-index">Time Index</h3>
<p>A fundamental element in the time-series database is the time index. You may be
wondering... where is it stored?</p>
<p>QuantumLeap will persist the <em>time index</em> for each notification in a special
column called <code>time_index</code>.  If you payed attention in the
<a href="#orion-subscription">Orion Subscription section</a>, you know at least which
value is used as the time index. This is, the <code>"dateModified"</code> value notified
by Orion or, if you missed that option in the subscription, the notification
arrival time.</p>
<p>In the future, this could be more flexible and allow users to define any
<code>DateTime</code> attribute to be used as the time index.</p>
<h2 id="data-removal">Data Removal</h2>
<p>You can remove historical data from QuantumLeap in two different ways.</p>
<p>To remove all records of a given entity, use <a href="https://app.swaggerhub.com/apis/smartsdk/ngsi-tsdb/0.1#/input/reporter.delete.delete_entity">this API endpoint</a>.</p>
<p>To remove all records of all entities of a given type, use <a href="https://app.swaggerhub.com/apis/smartsdk/ngsi-tsdb/0.1#/input/reporter.delete.delete_entities">this API endpoint</a>.</p>
<p>Use the filters to delete only records in certain intervals of time.</p>
<h2 id="multi-tenancy">Multi-tenancy</h2>
<p>QuantumLeap supports the use of different tenants, just like Orion does with
the usage FIWARE headers documented <a href="https://fiware-orion.readthedocs.io/en/master/user/multitenancy/index.html">here</a>.</p>
<p>Recall the use of tenancy headers (<code>Fiware-Service</code> and <code>Fiware-ServicePath</code>) is
optional. Data insertion and retrieval will work by default without those.
However, if you use headers for the insertion, you need to specify the same ones
when querying data.</p>
<p>Note in the case of QuantumLeap, the headers at the time of "insertion" should
actually be used by the client at the time of creating the
<a href="">Subscription to Orion</a> and also by the device when pushing data to Orion.
As mentioned, the same headers will have to be used in order to retrieve such
data.</p>
<p>In case you are interacting directly with the database, you need to know that
QuantumLeap will use the <code>FIWARE-Service</code> as the <a href="">database scheme</a> for crate,
with a specific prefix. This way, if you insert an entity of type <code>Room</code> in the
using the <code>Fiware-Service: magic</code> header, you should expect to find your table
at <code>mtmagic.etroom</code>. This information is also useful for example if you are
configuring the Grafana datasource, as explained in the <a href="../admin/grafana/">Grafana section</a> of the docs.</p>
<h2 id="geocoding">GeoCoding</h2>
<p>This is an optional and experimental feature of QuantumLeap, which helps
harmonising the way location information is stored in the historical records.</p>
<p>The idea is that if entities arrive in QuantumLeap with an attribute of type
<code>StructuredValue</code> and named <code>address</code>, QuantumLeap interprets this as an address
field typically found in the <a href="https://github.com/fiware/dataModels">FIWARE Data Models</a>.
It then adds to the entity an attribute called <code>location</code> of the corresponding
geo-type. This means, if the address is a complete address with city,
street name and postal number it maps to a point and hence the generated
attribute will be of type <code>geo:point</code>. Without a postal number, the address
will represent the street (if any) or the city boundaries (if any) or even the
country boundaries. In these cases the generated location will be of the
<code>geo:json</code> form and will contain the values of such shape.</p>
<p><strong>WARNING:</strong> This feature uses <a href="https://www.openstreetmap.org">OpenStreetMap</a>
and its Nominatim service. As such, you need to be aware of its <a href="https://www.openstreetmap.org/copyright">copyright notes</a> and most importantly of their
Usage Policies (<a href="https://operations.osmfoundation.org/policies/api/">API Usage Policy</a>
, <a href="https://operations.osmfoundation.org/policies/nominatim/">Nominatim Usage Policy</a>
You should not abuse of this free service and you should cache your requests.
This is why you need to specify a cache in order to enable the geocoding.
QuantumLeap uses <a href="https://redis.io/">Redis</a>.</p>
<p>So, to enable this feature, you need to pass (at initialisation time) to the
QuantumLeap container the environment variable <code>USE_GEOCODING</code> set to <code>True</code>
and the environment variables <code>REDIS_HOST</code> and <code>REDIS_PORT</code> respectively set to
the location of your REDIS instance and its access port. See the <a href="https://raw.githubusercontent.com/smartsdk/ngsi-timeseries-api/master/docker/docker-compose-dev.yml">docker-compose-dev.yml</a> for example.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="troubleshooting/" class="btn btn-neutral float-right" title="Troubleshooting">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href=".." class="btn btn-neutral" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/smartsdk/ngsi-timeseries-api.git/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href=".." style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="troubleshooting/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
